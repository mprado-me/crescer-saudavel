{% extends "admin/shared/base.html" %}

{% block title %}Imagens{% endblock %}

{% block content %}
  <a href="{{url_for('admin_add_image')}}">Adicionar nova imagem</a>
  <div class="br-8px"></div>

  {% if not data["empty"] %}
    {% with data=data["paginator_data"] %}
      {% include "shared/paginator.html" %}
    {% endwith %}

    <div class="table-responsive">
      <table class="table table-condensed table-hover">
        <thead>
          <tr>
            <th class="img-table-first-col"></th>
            <th>Nome</th>
            <th class="images-table-action-col"></th>
          </tr>
        </thead>
        <tbody>
          {% for image_name in data["images_name"] %}
            <tr>
              <td><img class="img-in-table" src="{{url_for('static', filename='uploads/images/'+image_name)}}"></td>
              <td><p>{{image_name}}</p></td>
              <td class="action">
                <form class="ajax remove" action="{{url_for('admin_remove_image', image_name=image_name)}}" method="post" image_name="{{image_name}}">
                  {{data["remove_form"].csrf_token}}
                  <input type="submit" class="btn btn-default" value="Remover">
                </form>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    {% with data=data["paginator_data"] %}
      {% include "shared/paginator.html" %}
    {% endwith %}
  {% else %}
    <p>Nenhuma imagem foi encontrada.</p>
  {% endif %}

{% endblock %}

{% block scripts %}
<script>
  $("form").filter(".ajax").filter(".remove").each(function(){
    var form = $(this)
    var submitInput = form.children().filter("input:submit");
    setAjaxFormHandlers({
      form: form,
      minResponseTime: 500,
      confirmMessage: "Tem certeza que deseja remover a imagem? Se algum produto utilizar está imagem, a apresentação de tal produto será prejudicada.",
      submit: function(){
        submitInput.prop("disabled", true)
        submitInput.attr("value", "Removendo...")
      },
      success: function(){
        submitInput.attr("value", "Imagem removida");
        form.closest("tr").addClass("removed");
      },
      error: function(){
        submitInput.prop("disabled", false)
        submitInput.attr("value", "Remover");

        toastr.options.closeButton = true;
        toastr.options.timeOut = 10000;
        toastr.error('Ocorreu uma falha ao remover a imagem "{0}". Tente novamente.'.f(form.attr("image_name")));
      },
    })
  })

  function setAjaxFormHandlers(data){
    var form = data.form;
    var minResponseTime = data.minResponseTime;
    var confirmMessage = data.confirmMessage;
    var submit = data.submit;
    var success = data.success;
    var error = data.error;

    form.submit(function(event){
      if(confirmMessage){
        var c = confirm(confirmMessage);
        if(!c){
          return false;
        }
      }
      if(!minResponseTime){
        minResponseTime = 0;
      }
      submit()
      form.clickTime = (new Date()).getTime();
      $.ajax({
        url: form.attr("action"),
        type: form.attr("method"),
        data: form.serialize(),
        async: true,
        success: function(){
          var postReturnTime = (new Date()).getTime();
          var delay = minResponseTime-(postReturnTime-form.clickTime);
          setTimeout(success, delay)
        },
        error: function(){
          var postReturnTime = (new Date()).getTime();
          var delay = minResponseTime-(postReturnTime-form.clickTime);
          setTimeout(error, delay)
        }
      })
      event.preventDefault()
      return true;
    })
  }
</script>
{% endblock %}